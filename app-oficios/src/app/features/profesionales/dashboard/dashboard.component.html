<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-top">
      <button class="back-btn" (click)="goBack()">
        <lucide-angular [img]="ArrowLeft" size="20"></lucide-angular>
        <span>Volver al Inicio</span>
      </button>
      <button class="logout-btn" (click)="logout()" title="Cerrar sesión">
        <lucide-angular [img]="LogOut" [size]="20"></lucide-angular>
        <span>Cerrar sesión</span>
      </button>
    </div>
    <div class="header-content">
      <h1>Dashboard Profesional</h1>
      <p class="welcome-text">Bienvenido, <strong>{{ userName() }}</strong></p>
    </div>
  </header>

  <!-- Metrics Grid -->
  <section class="metrics-section">
    <h2 class="section-title">Resumen de Métricas</h2>
    <div class="metrics-grid">
      <div *ngFor="let metric of metrics()" class="metric-card">
        <div class="metric-icon">
          <lucide-angular [img]="metric.icon" size="24"></lucide-angular>
        </div>
        <div class="metric-content">
          <p class="metric-title">{{ metric.title }}</p>
          <h3 class="metric-value">{{ metric.value }}</h3>
          <div class="metric-change" [class.positive]="metric.trend === 'up'" [class.negative]="metric.trend === 'down'">
            <lucide-angular [img]="TrendingUp" size="14"></lucide-angular>
            <span>{{ metric.change }} vs mes anterior</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Solicitudes Pendientes -->
  <section class="solicitudes-section" *ngIf="solicitudesPendientes().length > 0 || isLoadingSolicitudes()">
    <div class="section-header">
      <h2 class="section-title">
        <lucide-angular [img]="AlertCircle" size="24"></lucide-angular>
        Solicitudes Pendientes
      </h2>
      <span class="badge-count">{{ solicitudesPendientes().length }}</span>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoadingSolicitudes()" class="loading-container">
      <p>Cargando solicitudes...</p>
    </div>

    <!-- Solicitudes List -->
    <div *ngIf="!isLoadingSolicitudes()" class="solicitudes-grid">
      <div *ngFor="let solicitud of solicitudesPendientes()" class="solicitud-card">
        <div class="solicitud-header">
          <div class="client-info">
            <lucide-angular [img]="Users" size="20"></lucide-angular>
            <h3>{{ solicitud.nombreUsuario }}</h3>
          </div>
          <span class="time-badge">{{ formatTime(solicitud.fechasolicitud) }}</span>
        </div>

        <div class="solicitud-body">
          <div class="info-row">
            <lucide-angular [img]="Calendar" size="16"></lucide-angular>
            <span><strong>Fecha de servicio:</strong> {{ formatDate(solicitud.fechaservicio) }}</span>
          </div>

          <div class="info-row" *ngIf="solicitud.horaReserva">
            <lucide-angular [img]="Clock" size="16"></lucide-angular>
            <span><strong>Hora reservada:</strong> {{ formatHora(solicitud.horaReserva) }}</span>
          </div>

          <div class="info-row" *ngIf="solicitud.direccion">
            <lucide-angular [img]="FileText" size="16"></lucide-angular>
            <span><strong>Dirección:</strong> {{ solicitud.direccion }}</span>
          </div>

          <div class="observaciones" *ngIf="solicitud.observacion">
            <strong>Observaciones:</strong>
            <p>{{ solicitud.observacion }}</p>
          </div>
        </div>

        <div class="solicitud-actions">
          <button
            class="btn btn-reject"
            (click)="responderSolicitud(solicitud.idSolicitud, false)"
            [disabled]="respondingToSolicitud() === solicitud.idSolicitud"
          >
            <lucide-angular [img]="XIcon" size="18"></lucide-angular>
            <span>Rechazar</span>
          </button>
          <button
            class="btn btn-accept"
            (click)="responderSolicitud(solicitud.idSolicitud, true)"
            [disabled]="respondingToSolicitud() === solicitud.idSolicitud"
          >
            <lucide-angular [img]="Check" size="18"></lucide-angular>
            <span>{{ respondingToSolicitud() === solicitud.idSolicitud ? 'Procesando...' : 'Aceptar' }}</span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Mis Trabajos -->
  <section class="trabajos-section">
    <div class="section-header">
      <h2 class="section-title">
        <lucide-angular [img]="FileText" size="24"></lucide-angular>
        Mis Trabajos
      </h2>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoadingTrabajos()" class="loading-container">
      <p>Cargando trabajos...</p>
    </div>

    <!-- Tabla de Trabajos -->
    <div *ngIf="!isLoadingTrabajos()" class="trabajos-table-container">
      <div *ngIf="trabajos().length === 0" class="empty-state">
        <lucide-angular [img]="FileText" size="48"></lucide-angular>
        <p>No hay trabajos registrados</p>
      </div>

      <table *ngIf="trabajos().length > 0" class="trabajos-table">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Oficio</th>
            <th>Estado</th>
            <th>Fecha Inicio</th>
            <th>Fecha Fin</th>
            <th>Monto Final</th>
            <th>Estado Pago</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let trabajo of trabajos()">
            <td>{{ trabajo.nombreCliente }}</td>
            <td>{{ trabajo.oficio }}</td>
            <td>
              <span class="badge" [ngClass]="getEstadoBadgeClass(trabajo.estado)">
                {{ trabajo.estado }}
              </span>
            </td>
            <td>{{ trabajo.fechaInicio ? formatDate(trabajo.fechaInicio) : '-' }}</td>
            <td>{{ trabajo.fechaFinalizacion ? formatDate(trabajo.fechaFinalizacion) : '-' }}</td>
            <td>{{ formatMoneda(trabajo.montoFinal) }}</td>
            <td>
              <span *ngIf="trabajo.estadoPago" class="badge badge-pago">{{ trabajo.estadoPago }}</span>
              <span *ngIf="!trabajo.estadoPago">-</span>
            </td>
            <td>
              <div class="action-buttons">
                <!-- Iniciar trabajo (solo si está PENDIENTE) -->
                <button
                  *ngIf="trabajo.estado === 'PENDIENTE'"
                  class="btn-action btn-iniciar"
                  (click)="iniciarTrabajoManual(trabajo.idTrabajo)"
                  [disabled]="actionLoading() === trabajo.idTrabajo"
                  title="Iniciar trabajo">
                  <lucide-angular [img]="Play" [size]="16"></lucide-angular>
                </button>

                <!-- Pausar trabajo (solo si está EN_CURSO) -->
                <button
                  *ngIf="trabajo.estado === 'EN_CURSO'"
                  class="btn-action btn-pausar"
                  (click)="pausarTrabajoManual(trabajo.idTrabajo)"
                  [disabled]="actionLoading() === trabajo.idTrabajo"
                  title="Pausar trabajo">
                  <lucide-angular [img]="Pause" [size]="16"></lucide-angular>
                </button>

                <!-- Reanudar trabajo (solo si está PAUSADO) -->
                <button
                  *ngIf="trabajo.estado === 'PAUSADO'"
                  class="btn-action btn-reanudar"
                  (click)="reanudarTrabajoManual(trabajo.idTrabajo)"
                  [disabled]="actionLoading() === trabajo.idTrabajo"
                  title="Reanudar trabajo">
                  <lucide-angular [img]="Play" [size]="16"></lucide-angular>
                </button>

                <!-- Finalizar trabajo (solo si está EN_CURSO o PAUSADO) -->
                <button
                  *ngIf="trabajo.estado === 'EN_CURSO' || trabajo.estado === 'PAUSADO'"
                  class="btn-action btn-finalizar"
                  (click)="openFinalizarModal(trabajo.idTrabajo)"
                  [disabled]="actionLoading() === trabajo.idTrabajo"
                  title="Finalizar trabajo">
                  <lucide-angular [img]="Square" [size]="16"></lucide-angular>
                </button>

                <!-- Cancelar trabajo (si no está FINALIZADO ni CANCELADO) -->
                <button
                  *ngIf="trabajo.estado !== 'FINALIZADO' && trabajo.estado !== 'CANCELADO'"
                  class="btn-action btn-cancelar"
                  (click)="openCancelarModal(trabajo.idTrabajo)"
                  [disabled]="actionLoading() === trabajo.idTrabajo"
                  title="Cancelar trabajo">
                  <lucide-angular [img]="Ban" [size]="16"></lucide-angular>
                </button>

                <!-- Sin acciones disponibles -->
                <span
                  *ngIf="trabajo.estado === 'FINALIZADO' || trabajo.estado === 'CANCELADO'"
                  class="no-actions">
                  -
                </span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Quick Actions -->
  <section class="actions-section">
    <h2 class="section-title">Acciones Rápidas</h2>
    <div class="actions-grid">
      <div class="action-card" (click)="goToInvoices()">
        <div class="action-icon invoices">
          <lucide-angular [img]="FileText" size="32"></lucide-angular>
        </div>
        <h3>Facturas</h3>
        <p>Ver y gestionar tus facturas generadas</p>
      </div>

      <div class="action-card" (click)="goToReviews()">
        <div class="action-icon reviews">
          <lucide-angular [img]="Star" size="32"></lucide-angular>
        </div>
        <h3>Reseñas</h3>
        <p>Consultar valoraciones y comentarios de clientes</p>
      </div>

      <div class="action-card" (click)="goToMessages()">
        <div class="action-icon messages">
          <lucide-angular [img]="MessageSquare" size="32"></lucide-angular>
        </div>
        <h3>Mensajería</h3>
        <p>Chat con clientes y gestión de conversaciones</p>
      </div>

      <div class="action-card" (click)="goToPaymentMethods()">
        <div class="action-icon payments">
          <lucide-angular [img]="CreditCard" size="32"></lucide-angular>
        </div>
        <h3>Métodos de Pago</h3>
        <p>Agregar y gestionar formas de cobro</p>
      </div>
    </div>
  </section>

</div>

<!-- Modal de Finalizar Trabajo -->
<div *ngIf="showFinalizarModal()" class="modal-overlay" (click)="closeFinalizarModal()">
  <div class="modal-content finalizar-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <lucide-angular [img]="Square" [size]="24"></lucide-angular>
        Finalizar Trabajo
      </h2>
      <button class="btn-close" (click)="closeFinalizarModal()">
        <lucide-angular [img]="XIcon" [size]="20"></lucide-angular>
      </button>
    </div>

    <div class="modal-body">
      <p class="modal-description">Complete los siguientes campos para finalizar el trabajo:</p>

      <div class="form-group">
        <label for="descripcionFinal">Descripción de finalización *</label>
        <textarea
          id="descripcionFinal"
          rows="4"
          placeholder="Describa el trabajo realizado, materiales utilizados, etc."
          [value]="descripcionFinalizacion()"
          (input)="descripcionFinalizacion.set($any($event.target).value)"
        ></textarea>
      </div>

      <div class="form-group">
        <label for="costoFinal">Costo final (ARS) *</label>
        <input
          id="costoFinal"
          type="number"
          min="0"
          step="0.01"
          placeholder="0.00"
          [value]="costoFinalTrabajo()"
          (input)="costoFinalTrabajo.set(+$any($event.target).value)"
        />
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeFinalizarModal()">
        Cancelar
      </button>
      <button
        class="btn btn-primary"
        (click)="confirmarFinalizarTrabajo()"
        [disabled]="!descripcionFinalizacion() || costoFinalTrabajo() <= 0">
        Confirmar Finalización
      </button>
    </div>
  </div>
</div>

<!-- Modal de Cancelar Trabajo -->
<div *ngIf="showCancelarModal()" class="modal-overlay" (click)="closeCancelarModal()">
  <div class="modal-content cancelar-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <lucide-angular [img]="Ban" [size]="24"></lucide-angular>
        Cancelar Trabajo
      </h2>
      <button class="btn-close" (click)="closeCancelarModal()">
        <lucide-angular [img]="XIcon" [size]="20"></lucide-angular>
      </button>
    </div>

    <div class="modal-body">
      <p class="modal-description">Por favor indique el motivo de cancelación del trabajo:</p>

      <div class="form-group">
        <label for="motivoCancelacion">Motivo de cancelación *</label>
        <textarea
          id="motivoCancelacion"
          rows="4"
          placeholder="Explique por qué se cancela el trabajo..."
          [value]="motivoCancelacion()"
          (input)="motivoCancelacion.set($any($event.target).value)"
        ></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeCancelarModal()">
        Volver
      </button>
      <button
        class="btn btn-danger"
        (click)="confirmarCancelarTrabajo()"
        [disabled]="!motivoCancelacion()">
        Confirmar Cancelación
      </button>
    </div>
  </div>
</div>

<!-- Modal de Respuesta -->
<div *ngIf="showResponseModal()" class="modal-overlay" (click)="closeResponseModal()">
  <div class="modal-content response-modal" [class.success]="responseModalType() === 'success'" [class.error]="responseModalType() === 'error'" (click)="$event.stopPropagation()">
    <div class="modal-icon">
      <lucide-angular
        *ngIf="responseModalType() === 'success'"
        [img]="CheckCircle"
        [size]="64"
        class="icon-success">
      </lucide-angular>
      <lucide-angular
        *ngIf="responseModalType() === 'error'"
        [img]="AlertCircle"
        [size]="64"
        class="icon-error">
      </lucide-angular>
    </div>

    <h2>{{ responseModalType() === 'success' ? '¡Éxito!' : 'Error' }}</h2>
    <p class="modal-message">{{ responseModalMessage() }}</p>

    <button class="btn-close-modal" (click)="closeResponseModal()">
      Aceptar
    </button>
  </div>
</div>
